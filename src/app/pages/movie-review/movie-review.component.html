<div class="review-container">
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading movie details...</p>
  </div>

  <div *ngIf="!isLoading && movie" class="content-container">
    <div class="back-navigation">
      <button mat-icon-button (click)="goBack()" aria-label="Go back">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <span class="back-text">Back</span>
    </div>

    <mat-card class="movie-info-card">
      <div class="movie-header">
        <div class="movie-poster">
          <img
            [src]="movie.posterUrl || 'assets/placeholder-poster.jpg'"
            [alt]="movie.title"
            (error)="onImageError($event)"
          />
        </div>

        <div class="movie-details">
          <h1 class="movie-title">{{ movie.title }}</h1>

          <div class="movie-meta">
            <span *ngIf="movie.year" class="meta-item">{{ movie.year }}</span>
            <span class="meta-item">{{ movie.type | titlecase }}</span>
            <span *ngIf="getFormattedRuntime()" class="meta-item">{{
              getFormattedRuntime()
            }}</span>
          </div>

          <div class="watchlist-actions">
            <button
              *ngIf="!isInWatchlist()"
              mat-raised-button
              color="primary"
              (click)="onAddToWatchlist()"
            >
              <mat-icon>add</mat-icon>
              Add to Watchlist
            </button>
            <button
              *ngIf="isInWatchlist()"
              mat-raised-button
              color="accent"
              (click)="onRemoveFromWatchlist()"
            >
              <mat-icon>remove</mat-icon>
              Remove from Watchlist
            </button>
          </div>
        </div>
      </div>
    </mat-card>

    <mat-card class="review-form-card">
      <mat-card-header>
        <mat-card-title>
          {{ existingReview ? "Update Your Review" : "Write a Review" }}
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="reviewForm" (ngSubmit)="onSubmit()">
          <div class="rating-section">
            <div class="rating-label">Rating *</div>
            <div class="star-rating">
              <button
                *ngFor="let star of [1, 2, 3, 4, 5]"
                type="button"
                mat-icon-button
                class="star-button"
                [class]="getStarClass(star)"
                (click)="onStarClick(star)"
                (mouseenter)="onStarHover(star)"
                (mouseleave)="onStarLeave()"
                [attr.aria-label]="star + ' stars'"
              >
                <mat-icon>{{ getStarIcon(star) }}</mat-icon>
              </button>
            </div>
            <div class="rating-text">
              {{
                selectedRating > 0
                  ? selectedRating + "/5 stars"
                  : "Select a rating"
              }}
            </div>
            <div
              *ngIf="
                reviewForm.get('rating')?.invalid &&
                reviewForm.get('rating')?.touched
              "
              class="error-message"
            >
              {{ getRatingErrorMessage() }}
            </div>
          </div>

          <mat-form-field appearance="outline" class="review-textarea">
            <mat-label>Your Review</mat-label>
            <textarea
              matInput
              formControlName="reviewText"
              placeholder="Share your thoughts about this movie... (minimum 10 characters)"
              rows="6"
              maxlength="1000"
            ></textarea>
            <mat-hint align="end">
              {{ reviewForm.get("reviewText")?.value?.length || 0 }}/1000
            </mat-hint>
            <mat-error>
              {{ getReviewErrorMessage() }}
            </mat-error>
          </mat-form-field>

          <div class="form-actions">
            <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="reviewForm.invalid || isSubmitting"
              class="submit-button"
            >
              <mat-icon *ngIf="isSubmitting">hourglass_empty</mat-icon>
              <mat-icon *ngIf="!isSubmitting && existingReview">edit</mat-icon>
              <mat-icon *ngIf="!isSubmitting && !existingReview">send</mat-icon>
              {{
                isSubmitting
                  ? "Submitting..."
                  : existingReview
                  ? "Update Review"
                  : "Submit Review"
              }}
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <div *ngIf="!isLoading && !movie" class="error-container">
      <mat-card class="error-card">
        <mat-card-content>
          <div class="error-content">
            <mat-icon class="error-icon">error</mat-icon>
            <h2>Movie Not Found</h2>
            <p>The movie you're looking for could not be found.</p>
            <button mat-raised-button color="primary" (click)="goBack()">
              Back
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
